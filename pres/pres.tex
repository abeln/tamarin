\documentclass[pdf]{beamer}
\mode<presentation>{}

\usepackage{multicol}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{mips}
\usepackage{amsmath}
\usepackage{cancel}
\usepackage{tikz}
\usepackage{url}
\usetikzlibrary{shapes,backgrounds,arrows, fit, positioning}
\usepackage{algpseudocode}


\definecolor{CommentGreen}{rgb}{0,.6,0}
\lstset{
 language=[mips]Assembler,
 escapechar=@, % include LaTeX code between `@' characters
 keepspaces,   % needed to preserve spacing with lstinline
 basicstyle=\footnotesize\ttfamily\bfseries,
 commentstyle=\color{CommentGreen},
 stringstyle=\color{cyan},
 showstringspaces=false,
 keywordstyle=[1]\color{blue},    % instructions
 keywordstyle=[2]\color{magenta}, % directives
 keywordstyle=[3]\color{red},     % registers
 }
 
\lstset{language=[mips]Assembler}

%% preamble
\title{Tamarin: Concolic Disequivalence for MIPS}

\author{Abel Nieto}
\date{}

\newcommand{\crule}[3][black]{\textcolor{#1}{\rule{#2}{#3}}}

\begin{document}

\begin{frame}
\titlepage
\end{frame}

\begin{frame}{A Tale of Two Boxes}
~\\
\crule{3cm}{3cm} \hspace{2cm} \crule{3cm}{3cm}
\end{frame}

\begin{frame}{A Tale of Two Boxes}
\hspace{3.5cm}\fbox{\includegraphics[width=1cm]{carrot}}
\\
\crule{3cm}{3cm} \hspace{2cm} \crule{3cm}{3cm}
\pause
\\
nom nom
\pause
\hspace{3.5cm}
nom nom
\pause
\\
\hspace{3.5cm}
{\Huge $=$}
\end{frame}

\begin{frame}{A Tale of Two Boxes}
~\\
\fbox{\includegraphics[width=3cmcm]{camel}} \hspace{2cm} \fbox{\includegraphics[width=3cm]{beaver}}
\\
\hspace{5cm} {\Huge $\neq$}
\end{frame}

\Large

\begin{frame}{The Problem}
Given MIPS program $P_1$ and $P_2$, when are they equivalent?
\end{frame}

\begin{frame}{The Problem}
Attempt 1: two programs are equivalent if they give the same output (resp.) for all inputs.
\pause
\\~\\
\pause
What's an input?
\pause
Register $\$1$ and $\$2$.
\pause
\\
What's an output?
\pause
Register $\$3$. 
\pause
\\~\\
Don't care about (most) CPU interrupts/IO.
\end{frame}

\begin{frame}{The Problem}
Attempt 1: two programs are equivalent if they give the same output (resp.) for all inputs.
\pause
\\~\\
Problem: undecidable via Rice's theorem.
\end{frame}

\begin{frame}[fragile]{The Problem}
Attempt 2: two programs are $S$-equivalent if they cannot be told apart after $S$ steps.
\pause
\\~\\
$S$-equivalent (e.g. for $S = 10$), but not equivalent:
\begin{multicols}{2}
\begin{lstlisting}[escapeinside={(*}{*)}]
# P_1
add $3, $1, $2
\end{lstlisting}
\vfill\null
\columnbreak
\begin{lstlisting}
# P_2
  add $4, $0, 1  # counter
  add $5, $0, 42 # upper bound
loop:
  slt $6, $4, $5 
  beq $6, $0, end
  add $4, $4, 1
  beq $0, $0, loop
end:
  add $3, $1, $1  
\end{lstlisting}
\end{multicols}
\end{frame}

\begin{frame}{The Problem}
Attempt 2: two programs are $S$-equivalent if they \textbf{cannot be told apart} after $S$ steps.
\vspace{1cm}

\begin{tabular}{l | l | l}
$R_1$ & $R_2$ & $S$-equiv \\
\hline
\pause
$v$ & $v$ & yes \\
\pause
$v$ & $w \neq v$ & no \\
\pause
$v$ & error & no \\
\pause
error & error & yes \\
\pause
non-termination & ??? & yes \\
$\ldots$

\end{tabular}
\end{frame}

\begin{frame}{The Problem}
\begin{lemma}
Equivalence implies $S$-equivalence.
\end{lemma}

\pause
~\\
\begin{corollary}[Soundness]
If two programs are not $S$-equivalent (for any $S$), then they are not equivalent.
\end{corollary}
\end{frame}

\begin{frame}{The Problem}
Attempt 2: two programs are $S$-equivalent if they \textbf{cannot be told apart} after $S$ steps.
\\~\\
Which inputs?
\pause 
\\~\\
Try some inputs by hand: low coverage, fast (unit tests)
\pause
\\~\\
Try all $2^{64}$values of $\$1$ and $\$2$: high coverage, slow (but decidable)
\pause
\\~\\
\textbf{Tamarin}: use concolic execution: higher coverage(?), not too slow(?)
\end{frame}

\begin{frame}[fragile]{Idea}

Alternating concolic execution

\begin{multicols}{2}
\begin{lstlisting}[escapeinside={(*}{*)}]
# P_1
  bne $1, 42, end
  add $3, $3, $0
end:
  add $3, $1, $2
\end{lstlisting}
\vfill\null
\columnbreak
\begin{lstlisting}
# P_2
  add $3, $1, $2  
  bne $2, 100, end
  add $3, $3, $2
end:
\end{lstlisting}
\end{multicols}

\pause

\begin{tabular}{l | l | l | l | l | l | l | l}
Run & Driver & Verifier & $\$1$ & $\$2$ & Path & $R_D$ & $R_V$ \\
\hline
\pause
1 & $P_1$ & $P_2$ & 1 & 1 & $\$1 \neq 42$ & 2 & 2 \\
\pause
2 & $P_2$ & $P_1$ & 1 & 1 & $\$2 \neq 100$ & 2 & 2\\
\pause
3 & $P_1$ & $P_2$ & 42 & 1 & $\$1 = 42$ & 2 & 2 \\
\pause
4 & $P_2$ & $P_1$ & 1 & 100 & $\$2 = 100$ & \textcolor{red}{201} & \textcolor{red}{2}
\end{tabular}
\end{frame}

\normalsize

\begin{frame}{Tamarin (Overview)}
\begin{tikzpicture}[remember picture,overlay]

\node [draw] at (5,0) (tam) {Tamarin};
\node at (2, 0.5) (p1) {$P_1$};
\node at (2, -0.5) (p2) {$P_2$};
\node at (9, 0.5) (equiv) {$S$-equivalent};
\node at (9, -0.5) (neq) {not equivalent};


\draw [-latex] (p1) -- (tam);
\draw [-latex] (p2) -- (tam);
\draw [-latex,dashed] (tam) -- (equiv);
\draw [-latex,dashed] (tam) -- (neq);

\end{tikzpicture}
\end{frame}

\begin{frame}[fragile]{Tamarin (Overview)}
% Taken from http://www.texample.net/tikz/examples/simple-flow-chart/
% Define block styles
%\tikzstyle{decision} = [diamond, draw, fill=blue!20, 
%    text width=4.5em, text badly centered, node distance=3cm, inner sep=0pt]
\tikzstyle{block} = [rectangle, draw, fill=blue!20, 
    text width=3em, text centered, rounded corners, minimum height=2em]
    \tikzstyle{mainblock} = [rectangle, draw, fill=green!20, 
    text width=3.3em, text centered, rounded corners, minimum height=2em]
\tikzstyle{line} = [draw, -latex']
%\tikzstyle{cloud} = [draw, ellipse,fill=red!20, node distance=3cm,
%    minimum height=2em]
    
\begin{tikzpicture}[node distance = 1.5cm, auto]
    % Place nodes
    \node [mainblock] (concolic) {Concolic};
    \node [block, left of=concolic, node distance=5cm] (cpu) {CPU};
    \node [block, above of=concolic, right of=concolic, node distance=2cm] (trace) {Trace};
    \node [block, below of=trace, right of=trace, node distance=2.5cm] (query) {Query};
    \node [block, fill=red!20, below of=query, left of=query, node distance=3cm] (z3) {Z3};
    \node [draw=black, dashed, fit= (concolic) (cpu) (trace) (query)] {};
    \node at (-5.3, 3) {Tamarin};
    
%    % Draw edges
    \draw [line] (concolic) -- (cpu) node [midway, fill=white] {program};
%    \draw [-latex, bend left, dashed] (cpu) edge (concolic);
    \draw  (cpu)  edge [-latex, dashed, bend left=20] node[midway] {trace} (concolic);
    \draw [line] (concolic) -- (trace) node [midway]{trace};
    \draw [line] (trace) -- (query) node [midway]{modified trace};
    \draw [-latex, dashed] (query) -- (concolic) node [midway]{new path};
    \draw [line] (query) -- (z3) node [midway]{formula};
    \draw [-latex, dashed] (z3) edge [-latex, dashed, bend left=20] node[midway]{model} (query);
%    \path [line] (init) -- (identify);
%    \path [line] (identify) -- (evaluate);
%    \path [line] (evaluate) -- (decide);
%    \path [line] (decide) -| node [near start] {yes} (update);
%    \path [line] (update) |- (identify);
%    \path [line] (decide) -- node {no}(stop);
%    \path [line,dashed] (expert) -- (init);
%    \path [line,dashed] (system) -- (init);
%    \path [line,dashed] (system) |- (evaluate);
\end{tikzpicture}
\end{frame}

\Large

\end{document}